---
- hosts: all
  become: True
  gather_facts: False
  vars: 
    csv_file: ./auter-config.csv
  tasks:
    - name: Pre-check if servers has configuration set in CSV file
      become: False
      changed_when: False
      local_action: command grep ^{{ inventory_hostname }}, {{ csv_file }}

    - name: add the rs-epel repo
      failed_when: False
      register: result
      yum:
        name: rs-epel-release
        state: latest
      
    - name: add the epel repo
      when: "'No Package' in result.msg"
      yum:
        name: epel-release
        state: latest
      
    - name: install auter
      yum:
        name: auter
        state: latest

    - name: adjust the auter.conf file
      template:
        src: auter.conf.j2
        dest: /etc/auter/auter.conf

    - name: add warning to not edit yum.conf exclude manually
      lineinfile:
        line: "# WARNING: the excludes line is managed by auter through Ansible, do not edit it manually"
        insertbefore: "^exclude="
        dest: /etc/yum.conf

    - name: adjust the yum.conf excludes
      lineinfile:
        dest: /etc/yum.conf
        state: present
        regexp: ^exclude
        line: exclude={{ lookup('csvfile', inventory_hostname + ' file=auter-config.csv col=1 delimiter=,') }}

    - name: download getData to local directory
      become: False
      local_action: get_url
                    dest="./getData"
                    url="https://raw.githubusercontent.com/rackerlabs/getData/master/getData"

    - name: copy get-Data script to server
      copy:
        backup: yes
        dest: /usr/bin/getData
        group: root
        owner: root
        mode: 0755
        src: ./getData

    - name: create get-Data pre apply script
      lineinfile: 
        create: yes
        state: present
        dest: /etc/auter/pre-apply.d/01-getData-pre
        mode: 0755
        line: /usr/bin/getData --silent -d /root -t auter-getData-$(date +%Y-%m-%d) -p pre
 
    - name: create get-Data post apply script
      lineinfile: 
        create: yes
        state: present
        dest: /etc/auter/post-apply.d/50-getData-post-apply
        mode: 0755
        line: /usr/bin/getData -d /root -t auter-getData-$(date +%Y-%m-%d) -p post-update &> /root/auter-getData-$(date +%Y-%m-%d)/getData/post-update.compare

    - name: create get-Data post reboot script
      lineinfile: 
        create: yes
        state: present
        dest: /etc/auter/post-reboot.d/99-getData-post-reboot
        mode: 0755
        line: /usr/bin/getData -d /root -t auter-getData-$(date +%Y-%m-%d) -p post-reboot &> /root/auter-getData-$(date +%Y-%m-%d)/getData/post-reboot.compare

    - name: enable auter
      command: auter --enable

    - name: remove downloaded getData from local directory
      become: False
      local_action: file
                    dest="./getData"
                    state=absent
...
